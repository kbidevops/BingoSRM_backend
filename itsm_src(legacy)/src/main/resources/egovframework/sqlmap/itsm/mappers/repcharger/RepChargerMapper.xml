<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.smplatform.itsm.repcharger.dao.RepChargerMapper">
    <select id="retrieveList" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO" resultType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">
        SELECT
            SC.CMMN_CODE sysCode,
            SC.CMMN_CODE_NM sysCodeNm,
            SC.CMMN_CODE_SUB_NM1 sysCodeSubNm1,
            AA.USER_ID userId,
            LI.USER_LOCATE userLocat,
            LI.USER_NM userNm
        FROM TB_CMMN_CODE SC
        LEFT OUTER JOIN 
            TB_REP_CHARGER AA 
                    ON SC.CMMN_CODE = AA.SYS_CODE
            AND AA.USER_ID = #{userId}
            AND AA.DELETE_YN = 'N'
        LEFT OUTER JOIN
                    TB_LOGIN_INFO LI ON AA.USER_ID = LI.USER_ID
        <include refid="retrieveListWhere" />
        ORDER BY SC.CMMN_CODE_SUB_NM1 ASC, SC.SORT_NO, AA.USER_ID ASC
    </select>
    
    
    <sql id="retrieveListWhere">
    <where>
            SC.CMMN_CODE_TY = 'B1' 
            AND SC.DELETE_YN = 'N'
    </where>
    </sql>
    
    <select id="retrieveAssignList" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO" resultType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">
        SELECT 
            SC.CMMN_CODE sysCode,
            AA.USER_ID userId,
            LI.USER_NM userNm,
            SC.CMMN_CODE_NM sysCodeNm,
            SC.CMMN_CODE_SUB_NM1 sysCodeSubNm1,
            LI.USER_LOCATE userLocat
        FROM
            TB_CMMN_CODE SC
        JOIN TB_REP_CHARGER AA
                 ON SC.CMMN_CODE = AA.SYS_CODE
        LEFT OUTER JOIN TB_LOGIN_INFO LI
                 ON LI.USER_ID = AA.USER_ID
        WHERE SC.CMMN_CODE_TY = 'B1'
            AND SC.DELETE_YN = 'N'
            AND AA.DELETE_YN = 'N'
            AND LI.USER_STTUS_CODE = 'U002'
            <if test="userId != null and userId != ''">
            AND AA.USER_ID = #{userId}
            </if>
        ORDER BY SC.SORT_NO
    </select>
    
    <select id="retrieveUsers" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO" resultType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">
        SELECT DISTINCT 
                LI.USER_ID userId,
                LI.USER_NM userNm,
                LI.USER_LOCATE  userLocat
          FROM    TB_LOGIN_INFO LI
          LEFT JOIN    TB_REP_CHARGER RC
              ON LI.USER_ID = RC.USER_ID
         WHERE (
            RC.delete_YN = 'N'
            OR RC.delete_YN is null
            )
        AND LI.USER_TY_CODE in ('R001', 'R003')
        <if test="userLocat != null and userLocat != ''">
            AND LI.USER_LOCATE = #{userLocat}
        </if>
        <if test="reportCharger">
            AND RC.sys_code like 'B11%'
        </if>
    </select>
    
    <insert id="create" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">

        INSERT INTO TB_REP_CHARGER( SYS_CODE
                                     , USER_ID
                                     , DELETE_YN)
                            VALUES ( #{sysCode}
                                     , #{userId}
                                     , 'N')
        ON DUPLICATE KEY UPDATE DELETE_YN = 'N'

    </insert>
    
    <update id="delete" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">
        UPDATE  TB_REP_CHARGER
           SET
                   DELETE_YN = #{deleteYn}
         WHERE 
         <if test="sysCode != null and sysCode != ''">
                   SYS_CODE = #{sysCode}
         </if>
         <if test="userId != null and userId != '' and sysCode != null and sysCode != ''">
             AND
         </if>
         <if test="userId != null and userId != ''">
                 USER_ID = #{userId}
         </if>
    </update>
    
    <update id="update" parameterType="kr.go.smplatform.itsm.repcharger.vo.RepChargerVO">
        <selectKey keyProperty="repChargerId"  resultType="String" order="BEFORE">
            SELECT USER_ID
              FROM TB_REP_CHARGER
             WHERE SYS_CODE = #{sysCode}
               AND DELETE_YN = 'N'
        </selectKey>
        
        UPDATE  TB_REP_CHARGER
           SET
             <if test="userId != null and userId != ''">
                 USER_ID = #{userId}
            </if>
         WHERE 
                  SYS_CODE = #{sysCode}
           AND
                   USER_ID = #{repChargerId}
    </update>

    <update id="updateUserLocat">
        UPDATE    TB_LOGIN_INFO
        SET        USER_LOCATE = #{userLocat}
        WHERE    user_id = #{userId}
    </update>
    
</mapper>