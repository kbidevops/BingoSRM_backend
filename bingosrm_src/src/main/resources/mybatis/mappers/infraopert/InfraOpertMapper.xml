<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.smplatform.itsm.infraopert.dao.InfraOpertMapper">
	<sql id="retrieveSelect">
		SELECT
			  INFRA_OPERT_NO infraOpertNo
			, INFRA_PLAN_ATCHMNFL_ID infraPlanAtchmnflId
			, INFRA_RESULT_ATCHMNFL_ID infraResultAtchmnflId
			, INFRA_PLAN_ETC_ATCHMNFL_ID infraPlanEtcAtchmnflId
			, INFRA_RESULT_ETC_ATCHMNFL_ID infraResultEtcAtchmnflId
			, DELETE_YN deleteYn
			, CREAT_DT creatDt
			, CREAT_ID creatId
			, UPDT_DT updtDt
			, UPDT_ID updtId
		FROM TB_INFRA_OPERT
	</sql>
	<select id="retrieveList" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO" resultType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		<include refid="retrieveSelect" />
		WHERE DELETE_YN = 'N'
	</select>
	
	<select id="retrieve" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO" resultType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		<include refid="retrieveSelect" />
		WHERE DELETE_YN = 'N'
		  AND INFRA_OPERT_NO = #{infraOpertNo}
	</select>
	
	<insert id="create" useGeneratedKeys="true" keyProperty="infraOpertNo" keyColumn="INFRA_OPERT_NO" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		<selectKey  keyProperty="infraOpertNo" resultType="String" order="BEFORE">
			SELECT
				 ifnull(
				   (SELECT
				     CONCAT(
				       substring(
				         MAX(INFRA_OPERT_NO)
				        ,1
				        ,8)
				      ,LPAD(
				         CAST(
				           substring(
				             MAX(INFRA_OPERT_NO)
				            ,9) AS UNSIGNED) +
				         1
				        ,3
				        ,'0'))
				    FROM
				     TB_INFRA_OPERT
				    WHERE
				     INFRA_OPERT_NO LIKE
				       concat(
				         'IO-'
				        ,date_format(
				           now()
				          ,'%y%m')
				        ,'-%'))
				  ,concat(
				     'IO-'
				    ,date_format(
				       now()
				      ,'%y%m')
				    ,'-001'))
				   infraOpertNo
		</selectKey>
		
		INSERT INTO TB_INFRA_OPERT(INFRA_OPERT_NO 
			                        , INFRA_PLAN_ATCHMNFL_ID  	                        
			                        , INFRA_RESULT_ATCHMNFL_ID 
			                        , INFRA_PLAN_ETC_ATCHMNFL_ID 
			                        , INFRA_RESULT_ETC_ATCHMNFL_ID 
			                        , DELETE_YN 
			                        , CREAT_DT   
			                        , CREAT_ID   
			                        )
			VALUES (#{infraOpertNo}
			      , #{infraPlanAtchmnflId}
			      , #{infraResultAtchmnflId}
			      , #{infraPlanEtcAtchmnflId}
			      , #{infraResultEtcAtchmnflId}
			      , 'N'
			      , NOW()
			      , #{creatId}
			      )
	</insert>
	
	<update id="update" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		UPDATE TB_INFRA_OPERT
			   SET UPDT_DT = NOW()
			     , UPDT_ID = #{updtId}
			     , INFRA_PLAN_ATCHMNFL_ID = #{infraPlanAtchmnflId}
			     , INFRA_RESULT_ATCHMNFL_ID = #{infraResultAtchmnflId}
			     , INFRA_PLAN_ETC_ATCHMNFL_ID  = #{infraPlanEtcAtchmnflId}
			     , INFRA_RESULT_ETC_ATCHMNFL_ID  = #{infraResultEtcAtchmnflId}
			     , INFRA_OPERT_NO  = #{infraOpertNo_sub}
			WHERE INFRA_OPERT_NO = #{infraOpertNo}
	</update>
	
	<update id="deleteInfraOpertNo" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		UPDATE TB_INFRA_OPERT
		SET UPDT_DT = NOW()
			, UPDT_ID = 'codms121'
			, INFRA_OPERT_NO = concat(
									 'D',
									 (SELECT ifnull(a.cnt,0) FROM (select max(substr(infra_opert_no, 2,1))+1 cnt 
									   FROM TB_INFRA_OPERT 
									  WHERE INFRA_OPERT_NO LIKE 'D%' 
									    AND INFRA_OPERT_NO LIKE concat('%',substr(#{infraOpertNo}, 4))) a),
									 '-',
									 substr(#{infraOpertNo}, 4)
									 )
		WHERE INFRA_OPERT_NO = #{infraOpertNo}
	</update>
	
	<delete id="delete" parameterType="kr.go.smplatform.itsm.infraopert.vo.InfraOpertVO">
		UPDATE TB_INFRA_OPERT
			   SET DELETE_YN = 'Y'
		 WHERE INFRA_OPERT_NO= #{infraOpertNo}
	</delete>

</mapper>